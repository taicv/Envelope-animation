<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script>
            function atou(b64) {
                return decodeURIComponent(escape(atob(b64)));
            }

            function utoa(data) {
                return btoa(unescape(encodeURIComponent(data)));
            }
            function copyEncoded(inputId) {
                var encoded = document.getElementById(inputId).value;
                if (!encoded) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(encoded);
                } else {
                    var el = document.getElementById(inputId);
                    el.select();
                    try { document.execCommand('copy'); } catch (e) {}
                }
            }
            
            function generateImages(type) {
                var name = document.getElementById('nameInput').value;
                if (!name) {
                    alert('Please enter a name first');
                    return;
                }
                
                var encoded = utoa(name);
                
                // Display the images
                if (type === 'saigon') {
                    document.getElementById('letterImgSG').src = 'images/letter/?love=' + encoded + '';
                    document.getElementById('envelopeFrontImgSG').src = 'images/envelop-front/?love=' + encoded + '';
                    document.getElementById('imagesSectionSG').style.display = 'block';
                } else if (type === 'tuyphong') {
                    document.getElementById('letterImgTP').src = 'https://vy.taicv.com/card/images/letter/?love=' + encoded + '';
                    document.getElementById('envelopeFrontImgTP').src = 'https://vy.taicv.com/card/images/envelop-front/?love=' + encoded + '';
                    document.getElementById('imagesSectionTP').style.display = 'block';
                }
            }
            
            function generateVideo(type) {
                var name = document.getElementById('nameInput').value;
                if (!name) {
                    alert('Please enter a name first');
                    return;
                }
                
                // Get elements
                var statusId = type === 'saigon' ? 'statusSG' : 'statusTP';
                var buttonId = type === 'saigon' ? 'videoButtonSG' : 'videoButtonTP';
                var statusEl = document.getElementById(statusId);
                var buttonEl = document.getElementById(buttonId);
                
                // Disable button and show status
                buttonEl.disabled = true;
                statusEl.innerHTML = '<span class="spinner"></span>Generating video... This may take up to 30 seconds';
                statusEl.classList.add('show');
                
                var encoded = encodeURIComponent(utoa(name));
                
                // Check if running on localhost
                var isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                var baseUrl;
                if (isLocalhost) {
                    // Use localhost URL for both types
                    baseUrl = 'http://localhost/envelope-animation/?play=true&love=' + encoded;
                } else {
                    // Use production URLs
                    baseUrl = type === 'saigon' 
                        ? 'https://vy.taicv.com/thiep/?play=true&love=' + encoded
                        : 'https://vy.taicv.com/card/?play=true&love=' + encoded;
                }
                
                var videoUrl = 'https://f810781d5fea.ngrok-free.app/?url=' + encodeURIComponent(baseUrl) + '&key=babb4d6ba4dcd4a952c315226bfccf6c4b86907e';
                
                // Send fetch request with ngrok header
                fetch(videoUrl, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Response:', data);
                    
                    if (data.success && data.file) {
                        // Update status
                        statusEl.innerHTML = '<span class="spinner"></span>Video ready! Downloading...';
                        
                        // Extract the file path and download the video
                        var filePath = data.file;
                        var downloadUrl = 'https://f810781d5fea.ngrok-free.app' + filePath;
                        
                        // Download the file
                        fetch(downloadUrl, {
                            method: 'GET',
                            headers: {
                                'ngrok-skip-browser-warning': 'true'
                            }
                        })
                        .then(response => response.blob())
                        .then(blob => {
                            // Create download link
                            var url = window.URL.createObjectURL(blob);
                            var a = document.createElement('a');
                            a.href = url;
                            a.download = name + '.mp4';
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            
                            // Success message
                            statusEl.innerHTML = '✓ Video downloaded successfully as "' + name + '.mp4"';
                            statusEl.style.color = '#2da44e';
                            
                            // Re-enable button after 3 seconds
                            setTimeout(function() {
                                buttonEl.disabled = false;
                                statusEl.classList.remove('show');
                                statusEl.style.color = '#6f42c1';
                            }, 3000);
                        })
                        .catch(error => {
                            statusEl.innerHTML = '✗ Error downloading video: ' + error.message;
                            statusEl.style.color = '#d73a49';
                            buttonEl.disabled = false;
                            console.error('Download error:', error);
                            
                            setTimeout(function() {
                                statusEl.classList.remove('show');
                                statusEl.style.color = '#6f42c1';
                            }, 5000);
                        });
                    } else {
                        statusEl.innerHTML = '✗ Video generation failed. Please try again.';
                        statusEl.style.color = '#d73a49';
                        buttonEl.disabled = false;
                        
                        setTimeout(function() {
                            statusEl.classList.remove('show');
                            statusEl.style.color = '#6f42c1';
                        }, 5000);
                    }
                })
                .catch(error => {
                    statusEl.innerHTML = '✗ Error: ' + error.message;
                    statusEl.style.color = '#d73a49';
                    buttonEl.disabled = false;
                    console.error('Error:', error);
                    
                    setTimeout(function() {
                        statusEl.classList.remove('show');
                        statusEl.style.color = '#6f42c1';
                    }, 5000);
                });
            }
        </script>
        <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
            .field { margin-bottom: 16px; max-width: 720px; }
            label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
            input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box; }
            input[type="text"]:focus { border-color: #1f6feb; box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.15); }
            .input-row { display: flex; gap: 8px; align-items: stretch; }
            .input-row input[type="text"] { flex: 1; }
            .input-row button { flex-shrink: 0; }
            .actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
            button { padding: 8px 14px; border: 1px solid #1f6feb; background: #1f6feb; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; }
            button:hover { background: #1656c1; border-color: #1656c1; }
            button.secondary { background: #2da44e; border-color: #2da44e; }
            button.secondary:hover { background: #218838; border-color: #218838; }
            button.video { background: #6f42c1; border-color: #6f42c1; }
            button.video:hover { background: #5a32a3; border-color: #5a32a3; }
            button:disabled { background: #6c757d; border-color: #6c757d; cursor: not-allowed; opacity: 0.6; }
            .status-message { margin-top: 8px; font-size: 14px; color: #6f42c1; display: none; }
            .status-message.show { display: block; }
            .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #f3f3f3; border-top: 2px solid #6f42c1; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .images-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px; }
            .image-box img { width: 100%; border: 1px solid #d0d7de; border-radius: 8px; }
            .image-label { margin: 0 0 8px; font-size: 13px; color: #666; }
            @media (max-width: 768px) {
                .input-row { flex-wrap: wrap; }
                .input-row input[type="text"] { flex: 1 1 100%; min-width: 100%; }
            }
            @media (max-width: 640px) {
                .images-grid { grid-template-columns: 1fr; }
            }
        </style>
    </head>
<body>
    <div class="field">
        <label for="nameInput">Name</label>
        <input id="nameInput" type="text" placeholder="Enter name" onkeyup="var encoded = encodeURIComponent(utoa(this.value)); document.getElementById('encodedInput').value = 'https://vy.taicv.com/thiep/?love=' + encoded; document.getElementById('encodedInput2').value = 'https://vy.taicv.com/card/?love=' + encoded;" />
    </div>

    <div class="field">
        <label for="encodedInput">Link Thiệp Sài Gòn</label>
        <div class="input-row">
            <input id="encodedInput" type="text" placeholder="Generated link" readonly onclick="this.select();" />
            <button type="button" onclick="copyEncoded('encodedInput')">Copy</button>
            <button type="button" class="secondary" onclick="generateImages('saigon')">Generate images</button>
            <button type="button" id="videoButtonSG" class="video" onclick="generateVideo('saigon')">Generate Video</button>
        </div>
        <div id="statusSG" class="status-message"></div>
    </div>

    <div class="field" id="imagesSectionSG" style="display: none;">
        <label>Generated Images - Sài Gòn</label>
        <div class="images-grid">
            <div class="image-box">
                <p class="image-label">Letter</p>
                <img id="letterImgSG" src="" alt="Letter" />
            </div>
            <div class="image-box">
                <p class="image-label">Envelope Front</p>
                <img id="envelopeFrontImgSG" src="" alt="Envelope Front" />
            </div>
        </div>
    </div>

    <div class="field">
        <label for="encodedInput2">Link Thiệp Tuy Phong</label>
        <div class="input-row">
            <input id="encodedInput2" type="text" placeholder="Generated link" readonly onclick="this.select();" />
            <button type="button" onclick="copyEncoded('encodedInput2')">Copy</button>
            <button type="button" class="secondary" onclick="generateImages('tuyphong')">Generate images</button>
            <button type="button" id="videoButtonTP" class="video" onclick="generateVideo('tuyphong')">Generate Video</button>
        </div>
        <div id="statusTP" class="status-message"></div>
    </div>

    <div class="field" id="imagesSectionTP" style="display: none;">
        <label>Generated Images - Tuy Phong</label>
        <div class="images-grid">
            <div class="image-box">
                <p class="image-label">Letter</p>
                <img id="letterImgTP" src="" alt="Letter" />
            </div>
            <div class="image-box">
                <p class="image-label">Envelope Front</p>
                <img id="envelopeFrontImgTP" src="" alt="Envelope Front" />
            </div>
        </div>
    </div>

</body>
</html>